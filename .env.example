# ============================================
# REST API Downloader - Configuration Example
# ============================================
# Copy this file to .env and customize for your environment
# All settings have sensible defaults and are optional unless marked REQUIRED

# ============================================
# APPLICATION SETTINGS
# ============================================
ENVIRONMENT=development  # development, staging, production
APP_NAME="REST API Downloader"
APP_VERSION=0.5.0

# ============================================
# HTTP CLIENT SETTINGS
# ============================================
# Connection pool configuration
# Defaults based on high-concurrency testing; adjust for your traffic patterns
HTTP_MAX_KEEPALIVE_CONNECTIONS=100  # Connections to keep alive (default: 100)
HTTP_MAX_CONNECTIONS=200             # Total connection limit (default: 200, must be >= keepalive)
HTTP_KEEPALIVE_EXPIRY=30.0           # Seconds to keep idle connections (default: 30)

# Request settings
HTTP_REQUEST_TIMEOUT=30.0            # Request timeout in seconds (default: 30)
HTTP_MAX_REDIRECTS=10                # Maximum redirects to follow (default: 10)

# Concurrency limits
HTTP_MAX_CONCURRENT_API=20           # Max concurrent API requests (default: 20)
HTTP_MAX_CONCURRENT_BATCH=5          # Max concurrent batch requests (default: 5)

# HTTP/2 support
HTTP_HTTP2_ENABLED=true              # Enable HTTP/2 (default: true)

# ============================================
# PDF GENERATION SETTINGS
# ============================================
# PDF generation is CPU/memory intensive - conservative defaults
# Default concurrency: 2x CPU cores, max 12 (prevents memory exhaustion)
PDF_CONCURRENCY=12                   # Override auto-calculated concurrency

# Playwright browser settings
PDF_PAGE_LOAD_TIMEOUT=10000          # Page load timeout in ms (default: 10000)
PDF_WAIT_UNTIL=networkidle           # wait strategy: load, domcontentloaded, networkidle (default)
PDF_POOL_SIZE=3                      # Browser instances in pool (default: 3)

# ============================================
# BATCH PROCESSING SETTINGS
# ============================================
# Batch processing is I/O bound - more aggressive concurrency acceptable
# Default concurrency: 8x CPU cores, max 50
BATCH_CONCURRENCY=50                 # Override auto-calculated concurrency

# Batch limits
BATCH_MAX_URLS_PER_BATCH=50          # Max URLs per batch request (default: 50)
BATCH_DEFAULT_TIMEOUT_PER_URL=30     # Timeout per URL in seconds (default: 30)

# ============================================
# CONTENT PROCESSING SETTINGS
# ============================================
# Size limits for DoS protection
CONTENT_MAX_DOWNLOAD_SIZE=52428800   # Max download size in bytes (default: 50MB)

# Content conversion cache
CONTENT_CACHE_MAX_SIZE=1000          # Max cached items (default: 1000)
CONTENT_CACHE_CLEANUP_INTERVAL=3600  # Cache cleanup interval in seconds (default: 1 hour)

# ============================================
# REDIS SETTINGS (Optional - for batch job management)
# ============================================
# Leave empty to disable batch job persistence
REDIS_URI=                           # Example: redis://localhost:6379
REDIS_MAX_CONNECTIONS=10             # Redis connection pool size (default: 10)

# ============================================
# AUTHENTICATION SETTINGS (Optional)
# ============================================
# Leave empty to disable authentication
DOWNLOADER_KEY=                      # API key for authentication (empty = auth disabled)

# ============================================
# LOGGING SETTINGS
# ============================================
# Log levels: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO                       # Application log level (default: INFO)
LOG_ACCESS_LOG_LEVEL=INFO            # Uvicorn access log level (default: INFO)

# Structured logging (recommended for production)
LOG_JSON_LOGS=false                  # Enable JSON logs (default: false, set true in production)

# Log file paths (empty = stdout/stderr)
LOG_ACCESS_LOG_FILE=                 # Access log file path (empty = stdout)
LOG_ERROR_LOG_FILE=                  # Error log file path (empty = stderr)

# Production examples:
# LOG_ACCESS_LOG_FILE=/var/log/downloader/access.log
# LOG_ERROR_LOG_FILE=/var/log/downloader/error.log

# Log rotation
LOG_ROTATION_SIZE=10485760           # Rotate at 10MB (default)
LOG_ROTATION_COUNT=5                 # Keep 5 rotated files (default)

# ============================================
# SSRF PROTECTION SETTINGS
# ============================================
# Security settings to prevent Server-Side Request Forgery attacks
SSRF_BLOCK_PRIVATE_IPS=true          # Block private IP addresses (default: true)
SSRF_BLOCK_CLOUD_METADATA=true       # Block cloud metadata endpoints (default: true)
SSRF_RESOLVE_DNS=true                # Resolve DNS before requests (default: true)

# ============================================
# CORS SETTINGS
# ============================================
# SECURITY: Default allows only localhost (ports 3000, 8080)
# You MUST set explicit origins for production deployments

# Production - set your domains:
CORS_ALLOWED_ORIGINS=https://myapp.com,https://admin.myapp.com

# Development uses localhost by default (no change needed)
# DANGEROUS - avoid in production:
# CORS_ALLOWED_ORIGINS=*

# ============================================
# RATE LIMITING SETTINGS
# ============================================
# Prevent DoS attacks and ensure fair resource allocation
# Limits format: "count/period" (e.g., "100/minute")
# Periods: second, minute, hour, day

RATELIMIT_ENABLED=true                    # Enable rate limiting (default: true)
RATELIMIT_DEFAULT_LIMIT=100/minute        # Default limit for all endpoints
RATELIMIT_DOWNLOAD_LIMIT=60/minute        # Limit for download endpoints (resource-intensive)
RATELIMIT_BATCH_LIMIT=20/minute           # Limit for batch job creation (async)
RATELIMIT_STATUS_LIMIT=200/minute         # Limit for status/metrics endpoints (lightweight)

# Storage backend for distributed rate limiting
# If not set, uses REDIS_URI. Falls back to in-memory (single instance only)
# RATELIMIT_STORAGE_URI=redis://redis-host:6379

# Response headers
RATELIMIT_HEADERS_ENABLED=true            # Include X-RateLimit-* headers (default: true)

# ============================================
# QUICK START EXAMPLES
# ============================================

# DEVELOPMENT (default - no config needed)
# - Auth disabled
# - Console logging
# - Auto-calculated concurrency
# Just run: uvicorn src.downloader.main:app

# PRODUCTION EXAMPLE
# ENVIRONMENT=production
# DOWNLOADER_KEY=your-secret-api-key-here
# REDIS_URI=redis://redis-host:6379
# LOG_JSON_LOGS=true
# LOG_ACCESS_LOG_FILE=/var/log/downloader/access.log
# LOG_ERROR_LOG_FILE=/var/log/downloader/error.log
# CORS_ALLOWED_ORIGINS=https://yourdomain.com
# PDF_CONCURRENCY=8
# BATCH_CONCURRENCY=32

# HIGH PERFORMANCE EXAMPLE (8-core machine, 16GB RAM)
# PDF_CONCURRENCY=16
# BATCH_CONCURRENCY=64
# HTTP_MAX_KEEPALIVE_CONNECTIONS=200
# HTTP_MAX_CONNECTIONS=400
# HTTP_MAX_CONCURRENT_API=50
# CONTENT_MAX_DOWNLOAD_SIZE=104857600  # 100MB

# MEMORY CONSTRAINED EXAMPLE (2GB RAM VPS)
# PDF_CONCURRENCY=2
# BATCH_CONCURRENCY=8
# PDF_POOL_SIZE=1
# CONTENT_MAX_DOWNLOAD_SIZE=10485760   # 10MB
# HTTP_MAX_KEEPALIVE_CONNECTIONS=20
# HTTP_MAX_CONNECTIONS=40
